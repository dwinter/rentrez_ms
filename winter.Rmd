---
title: "rentrez An R pacakge for the NCBI eutils API"
author:
  - name: David Winter
    affiliation: Massey University
    address:
    - line 1
    - line 2
    email:  d.winter@massey.ac.nz
abstract: >
  An abstract of less than 150 words.
output: 
    html_document:
        keep_md: true

---

```{r, count_recs, echo=FALSE}
library(rentrez)
count_recs <- function(db, denom,round_to=1) {
    nrecs <-  rentrez::entrez_db_summary(db)["Count"]
    round(as.integer(nrecs)/denom, round_to)
}

```

## Introduction

The USA National Center for Biotechnology Information (NCBI) is one of the world's 
largest and most important sources of biological data. At the time of writing, the NCBI
PubMed database provided information on $`r count_recs("pubmed",1e6)`$ million journal
articles, including $`r count_recs("pmc", 1e6)`$ million full text records. The NCBI
Nucleotide Database (including GenBank) had data for $`r count_recs("nuccore",
1e6)`$ million different sequences and dbSNP described $`r count_recs("snp", 1e6)`$ 
million different genetic variants. Records from all of these databases can be 
cross-referenced with the  $`r round(entrez_search(db="taxonomy", term='species[RANK]')$count/1e6,1)`$ 
million species in the NCBI taxonomy, and PubMed entries can be searched for using a 
controlled vocabulary containing $`r count_recs("MeSH", 1e3,0)`$ thousand unique terms. 

The NCBI provides access to a total of $`r length(entrez_dbs())`$ databases 
through a web interface,public FTP sites and a REST API called Entrez Programming Utilities (EUtils). A
R packages from the Bioconductor project (e.g., \\BIOpkg{genomes}, 
\\BIOpkg{RMassBank} and \\BIOpkg{MeSHSim}) or available from CRAN 
(e.g., \\CRANpkg{ape}, \\CRANpkg{RISmed} and \\CRANpkg{pubmed.mineR}) 
take advantage of the Eutils API to perform specific tasks. Two packages,
\\CRANpkg{rentrez} and \\CRANpkg{reutils}, provide functions that cover the entire 
API.  

Here I describe \\pkg{rentrez}, a package which provides users with a simple and
consistent interface to EUtils. In this paper I describe the design of the package, 
illustrate its use in biological research and demonstrate how the functions provided by \\pkg{rentrez}
can aid the development of other packages designed to meet more specific goals.


## The EUtils API and \\\\pkg{rentrez}

The EUtils API provides endpoints for searching each of the databases it covers, 
finding cross-references among records in those databases and fetching 
particular records (in complete or summary form). The design of \\pkg{rentrez} 
mirrors that of EUtils, with each of these endpoints represented by a core
function that has arguments named to match those used in the API documentation
(Table \\ref{tab:core-ends}). The most important arguments to the R functions are
documented, and each ofthe help pages contains a reference to relevant section of the 
EUtils documentation to give users detailed information on how to make the most
of each endpoint.

\\begin{table}[]
\\centering
\\caption{Core EUtils endpoints and their \\pkg{rentrez} counterparts}
\\label{tab:core-ends}
\\begin{tabular}{llll}
\\hline
NCBI endpoint & Purpose                                         & Core function   \\\\ \\hline
esearch       & Locate records matching search criteria.        & \\texttt{entrez\\_search}  \\\\ 
elink         & Discover of cross-linked records.               & \\texttt{entrez\\_link}    \\\\ 
esummary      & Fetch summary data on a set of records.         & \\texttt{entrez\\_summary} \\\\ 
efetch        & Fetch complete records in a variety of formats. & \\texttt{entrez\\_fetch}   \\\\ \\hline
\\end{tabular}
\\end{table}


Typically, a user will begin by using `entrez_search` to discover unique
identifiers for database records matching particular criteria. For example, the
following call takes advantage of the EUtils search syntax (which is described in the
functoin's help page) to discover scientific papers that were published in 2017 
and contain the phrase "R Package" in their title.


```{r, pmed_search}
pubmed_search <- entrez_search(db="pubmed", 
                               term="(R package[TITL]) AND 2017[PDAT]", 
                               use_history=TRUE)
pubmed_search
```

The object returned by `entrez_search` can contain identifiers for records that
match the given search term or a `web_history` object that serves as a reference 
to a set of identifiers stored on the NCBI's servers. Identifiers or
`web_history` objects can be passed to the other core functions to retrieve
information about the records they represent. For example, a call to
`entrez_summary` returns information about each paper identified in the search
above.

```{r}
pkg_paper_summs <- entrez_summary(db="pubmed", web_history=pubmed_search$web_history)
pkg_paper_summs
```

In addition to matching each of the EUtils endpoints, \\pkg{rentrez} provides a
utility functions that facilitate common workflows. For example, the
function \\texttt{extract_from_summary} allows users to extract some subset of
the items from each of the summary records. In this case, the names of the 
journals in which these papers appeared can be isolated.

```{r, journal_names}
journals <- extract_from_esummary(pkg_paper_summs, "fulljournalname")
head(journals,3)
```

## Demonstration: retrieving unique transcripts for a given gene

The package includes an extensive vignette, which can be accessed from within an
R session by typing `vignette(topic="rentrez_tutorial")`. This document combines
extensive documentation on each of the EUtils endpoints with detailed workflows
that combine different \\pkg{rentrez} functions to analyse biological data. Here
I add an additional demonstration, illustrating how \\pkg{rentrez} can
automate the process of retrieving DNA sequence data corresponding to mRNA
transcripts produced from a given gene.

We start by assuming a user wishes to retrieve the sequence of mRNA transcripts 
associated with the gene that encodes Amyloid Beta Precursor Portein in humans, 
and that they know this gene has the gene symbol `APP`. With this information 
available, the first step to acquiring the DNA sequence data is identifying the 
correct gene in the NCBI's Gene database. This can be achieved using `entrez_search`.


```{r, app_search}
app_gene <- entrez_search(db="gene", term="(Homo sapiens[ORGN]) AND APP[GENE]")
app_gene
```

The object returned here contains the unique identifier for a record in the Gene
database. Our goal is to obtain sequence data, which is stored in the
Nucleotide database. The function `entrez_link` can be used to find 
records in one database that correspond to entries in another. In this case, a
single call to `entrez_link` can identify human APP sequences in the nucleotide
database in general and a restrictive subsets of that database in
particular.

```{r, app_links}
nuc_links <- entrez_link(dbfrom='gene', id=app_gene$ids, db='nuccore')
nuc_links$links
```

The goal here is to identify unique mRNA transcripts associate with our gene of
interest. The `refseqrna` subset on the Nucleotide database is thus the
appropriate set of sequences to download. The function `entrez_fetch` allows
users to retrieve complete records in a variety for formats. Here the sequences
are retrieved in the standard fasta format, and returned as a character vector
with a single element.


```{r, app_seq_raw}
raw_recs <- entrez_fetch(db="nuccore", id=nuc_links$links$gene_nuccore_refseqrna, rettype="fasta")
cat(substr(raw_recs, 1,306), "\\n...\\n")
```

Sequences retrieved in this way could be written to file using `write`.
Alternatively, they could be analysed  within R using packages designed for
sequence data. For instance, the data base be represented as a `DNAbin` object
using the phylogentics package \\CRANpkg{ape}.

```{r, app_seq_ape}
tf <- tempfile()
cat(raw_recs,file= tf)
ape::read.dna(tf, format="fasta")
```

## Demonstration: development of a new package

Development of \\pkg{rentrez} has deliberately focused on producing a "low-level"
package that provides a flexible interface to the entire the EUtils API. As a 
result the package does not provide functions for any particular analysis
or return records in any of the object classes made available for biological
data by other packages. Rather, it is hoped that by providing a reliable interface
to the EUtils API that meets the NCBI's terms of use \\\\pkg{rentrez} will allow
developers ...


```{r, tidytaxa, cache=FALSE}
devtools::load_all("tidytaxon")

animal_orders <- tidy_taxonomy("animals", 
                               lowest_rank="order",
                               higher_ranks=c("phylum", "class"))

animal_orders$spp <- taxon_children(animal_orders$order)
animal_orders$genomes <- taxon_records(animal_orders$order, db="genome")
animal_orders$sequences <- taxon_records(animal_orders$order, db="nuccore")
animal_orders$papers <- taxon_records(animal_orders$order, db="pubmed")
head(animal_orders,3)

write.csv(animal_orders, file="animal_data.csv", row.names=FALSE)
```

```{r, treemaps}

library(treemap)
library(grid)
library(gridExtra)

#Create a common colour palette for both plots. 
spp_by_phyl <- aggregate(spp ~ phylum, FUN=sum, data=animal_orders)
phyla <- spp_by_phyl$phylum[ order(spp_by_phyl$spp, decreasing=TRUE)]
pal <- structure( rep(RColorBrewer::brewer.pal(name="Accent", n=6),4), .Names=phyla)
animal_orders$fill <- pal[ animal_orders$phylum ]

commafy <- function(n)  formatC(n, format = "d", big.mark = ",")
             
grid.newpage()
pushViewport(viewport(layout = grid.layout(2, 2)))


tm <- treemap(animal_orders, 
        index=c("phylum", "class", "order"), vSize="spp", vColor="fill", 
        palette=pal, type='categorical', position.legend="none", 
        title=paste0("species (n = ", commafy(sum(animal_orders$spp)), ")"),       
        border.col=c("white","white","black"),
        vp = viewport(layout.pos.row = 1, layout.pos.col = 1)
)

treemap(animal_orders, 
        index=c("phylum", "class", "order"), vSize="papers", vColor="fill", 
        palette=pal, type='categorical', position.legend="none", 
        title=paste0("papers (n = ", commafy(sum(animal_orders$papers)), ")"),       
        border.col=c("white","white","black"),
        vp = viewport(layout.pos.row = 1, layout.pos.col = 2)
)

treemap(animal_orders, 
        index=c("phylum", "class", "order"), vSize="sequences", vColor="fill", 
        palette=pal, type='categorical', position.legend="none", 
        title=paste0("sequences (n = ", commafy(sum(animal_orders$sequences)), ")"),       
        border.col=c("white","white","black"),
        vp = viewport(layout.pos.row = 2, layout.pos.col = 1)
)

treemap(animal_orders, 
        index=c("phylum", "class", "order"), vSize="genomes", vColor="fill", 
        palette=pal, type='categorical', position.legend="none",
        title=paste0("genomes (n = ", commafy(sum(animal_orders$genomes)), ")"),       
        border.col=c("white","white","black"),
        vp = viewport(layout.pos.row = 2, layout.pos.col = 2)
)      


```


\\bibliography{RJreferences}
